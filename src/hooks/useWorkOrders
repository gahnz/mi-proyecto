import { useState, useEffect } from 'react';
import { supabase } from '../supabase/client';

export const useWorkOrders = () => {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(true);

  const fetchOrders = async () => {
    setLoading(true);
    const { data, error } = await supabase
      .from('work_orders')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Error cargando Ã³rdenes:', error);
    } else {
      // Mapeamos para compatibilidad con la UI existente
      const mappedOrders = data.map(o => ({
        ...o,
        // La UI espera 'id' como string visible (OT-XXX), pero guardamos DB ID en db_id
        db_id: o.id, 
        id: o.display_id || `OT-${o.id}`,
        customer: o.customer_name,
        device: o.device_name,
        type: o.device_type,
        problem: o.reported_fault,
        technician: o.technician_name,
        cost: o.total_cost,
        date: new Date(o.created_at).toLocaleDateString()
      }));
      setOrders(mappedOrders);
    }
    setLoading(false);
  };

  const createOrder = async (orderData) => {
    // Generar ID visual
    const displayId = `OT-${Math.floor(1000 + Math.random() * 9000)}`;
    
    const payload = {
      display_id: displayId,
      customer_id: orderData.clientId,
      customer_name: orderData.customerName,
      equipment_id: orderData.equipmentId ? parseInt(orderData.equipmentId) : null,
      device_name: orderData.deviceName,
      device_type: orderData.deviceType,
      status: orderData.status,
      location: orderData.location,
      job_type: orderData.jobType,
      reported_fault: orderData.reportedFault,
      internal_notes: orderData.internalNotes,
      technician_name: orderData.technician,
      start_date: orderData.startDate,
      estimated_end_date: orderData.estimatedEndDate,
      items: orderData.selectedItems,
      total_cost: orderData.totalCost,
      payment_method: orderData.paymentMethod
    };

    const { error } = await supabase.from('work_orders').insert([payload]);
    if (error) throw error;
    await fetchOrders();
  };

  const updateOrder = async (dbId, updates) => {
    // Convertir keys de camelCase a snake_case si es necesario
    const payload = {
      status: updates.status,
      technician_name: updates.technician,
      prob_real: updates.probReal,
      sol_real: updates.solReal,
      observations: updates.obs,
      photo_before: updates.photoBefore,
      photo_after: updates.photoAfter,
      receiver_name: updates.receiverName,
      receiver_signature: updates.receiverSignature,
      // ... mapear otros campos si se editan
    };

    // Limpiar undefined
    Object.keys(payload).forEach(key => payload[key] === undefined && delete payload[key]);

    const { error } = await supabase.from('work_orders').update(payload).eq('id', dbId);
    if (error) throw error;
    await fetchOrders();
  };

  useEffect(() => {
    fetchOrders();
  }, []);

  return { orders, loading, createOrder, updateOrder, refresh: fetchOrders };
};